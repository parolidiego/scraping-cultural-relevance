---
title: "The Guardian API"
author: "David Pereiro Pol"
date: "2025-03-16"
output: html_document
---

```{r setup, include=FALSE}
usethis::edit_r_environ()
# file.edit("~/.Renviron")
# Sys.getenv("API_KEY_NYT")
```

```{r}
library(httr2)
library(tidyverse)
main_link <- "https://content.guardianapis.com/search"

# Trying out a query to understand structure
data <- main_link |> 
  request() |>
  req_url_query(`api-key` = Sys.getenv("API_KEY_GUARDIAN"), format = "json",
                `from-date` = "2000-01-01", `to-date` = "2000-01-05", 
                `order-by` = "relevance", `use-date` = "newspaper-edition",
                section = "world", `show-fields` = "headline,trailText,standfirst",
                `page-size` = 50) |> 
  req_perform() |> 
  resp_body_json(simplifyVector = TRUE)

data$response$results$

news <- tibble(
  date = data$response$results$webPublicationDate,
  title = data$response$results$webTitle,
  subtitle = data$response$results$fields$trailText,
  standfirst = data$response$results$fields$standfirst,
  url = data$response$results$webUrl
)

news <- news |> 
  mutate(date = str_remove_all(date,"T.+00$"),
         date = as_date(date),
         rank = row_number()) |> 
  group_by(date) |> 
  slice_min(rank) |> 
  ungroup() |> 
  select(-rank)
  
```

```{r}
dates <- seq(as.Date("2000-01-01"), as.Date("2000-01-05"), by = "3 days")

dates_creator <- function(start, end) {
  # To be provided as "yyyy-mm-dd"
  
  start_dates <- seq(as.Date(start), as.Date(end), by="4 days")
  end_dates <- start_dates + 3
  
  start_dates <- start_dates |> 
    as.character() 
  
  end_dates <- end_dates |> 
    as.character() 
  
  list_dates <- list(start_dates, end_dates)
  
  return(list_dates)
}


dates <- dates_creator("2004-04-01", "2004-05-01")

start_dates <- dates[[1]]
start_dates
end_dates <- dates[[2]]
end_dates

guardian_news <- function(start_date, end_date){
  
  api_key <- Sys.getenv("API_KEY_GUARDIAN")
  if (api_key == "") stop("API key is missing! Set 'API_KEY_GUARDIAN' in your environment.")
   
  Sys.sleep(1)
  
  main_link <- "https://content.guardianapis.com/search"
  
  data <- main_link |> 
  request() |>
  req_url_query(`api-key` = Sys.getenv("API_KEY_GUARDIAN"), format = "json",
                `from-date` = start_date, `to-date` = end_date, 
                `order-by` = "relevance", `use-date` = "newspaper-edition",
                section = "world", `show-fields` = "headline,trailText,standfirst",
                `page-size` = 50) |> 
  req_perform() |> 
  resp_body_json(simplifyVector = TRUE)
  
  news <- tibble(
    date = data$response$results$webPublicationDate,
    title = data$response$results$webTitle,
    subtitle = data$response$results$fields$trailText,
    standfirst = data$response$results$fields$standfirst,
    url = data$response$results$webUrl
  )
  
  news <- news |> 
  mutate(date = str_remove_all(date,"T.+$"))|> 
  mutate(date = str_trim(date)) |>     
  mutate(date = as_date(date)) |>  
  mutate(rank = row_number())  |> 
  group_by(date) |> 
  slice_min(rank, with_ties = FALSE) |> 
  ungroup() 
  
  return(news)
}

news5 <- map2_dfr(start_dates, end_dates, guardian_news)
```

